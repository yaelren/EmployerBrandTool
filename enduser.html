<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Spotlight - Employer Brand Tool</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Wix+Madefor+Display:wght@400..800&family=Wix+Madefor+Text:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">

    <!-- Chatooly CDN Styles -->
    <link rel="stylesheet" href="https://yaelren.github.io/chatooly-cdn/css/unified.min.css">

    <!-- End-User Custom Styles -->
    <link rel="stylesheet" href="css/enduser.css">

    <!-- Chatooly App Scripts -->
    <script src="js/utils/ColorUtils.js"></script>
    <script src="js/utils/FontLoader.js"></script>
    <script src="js/canvas/CanvasManager.js"></script>
    <script src="js/canvas/DebugController.js"></script>
    <script src="js/background/BackgroundController.js"></script>
    <script src="js/text/TextComponent.js"></script>
    <script src="js/text/SpotTextComponent.js"></script>
    <script src="js/text/MainTextController.js"></script>
    <script src="js/grid/GridCell.js"></script>
    <script src="js/grid/GridSystem.js"></script>
    <script src="js/grid/CellRenderer.js"></script>
    <script src="js/layers/LayerController.js"></script>
    <script src="js/media/MediaController.js"></script>
    <script src="js/parameters/PresetManager.js"></script>
    <script src="js/parameters/ContentSlotTypes.js"></script>
    <script src="js/parameters/ContentSlotManager.js"></script>
    <script src="js/parameters/PresetPageManager.js"></script>
    <script src="js/app.js"></script>
</head>
<body>
    <!-- Preset Selector Modal -->
    <div class="preset-selector-overlay" id="presetSelector">
        <div class="preset-selector-modal">
            <div class="preset-selector-header">
                <h2 class="preset-selector-title">Choose Your Preset</h2>
            </div>
            <div class="preset-selector-body">
                <label class="modal-preset-label">Select a preset to get started:</label>
                <select class="modal-preset-dropdown" id="modalPresetDropdown">
                    <option value="">-- Select Preset --</option>
                    <option value="employee-spotlight">Employee Spotlight (3 pages)</option>
                    <option value="tour-promo">Tour Promo (3 pages)</option>
                    <option value="early-talent">Early Talent Program (4 pages)</option>
                    <option value="city-guides">City Guides (5 pages)</option>
                </select>
                <button class="modal-load-btn" onclick="loadPresetFromModal()">
                    Load Preset
                </button>
            </div>
        </div>
    </div>

    <!-- Main End-User Interface -->
    <div class="enduser-container" id="mainInterface">
        <!-- Header -->
        <div class="enduser-header">
            <div class="header-left">
                <h1 class="header-title">Employer Brand Tool</h1>
                <span class="header-subtitle">End User</span>
            </div>
            <div class="header-right">
                <span class="preset-loaded-name" id="presetLoadedName">Employee Spotlight</span>
            </div>
        </div>

        <!-- Export Bar (below header) -->
        <div class="export-bar" id="exportBar">
            <button class="export-bar-btn" onclick="exportAllPages()">
                Export
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="enduser-main">
            <!-- Left Sidebar: Form -->
            <div class="enduser-sidebar">
                <div class="sidebar-header" id="sidebarHeader">
                    <h2 class="sidebar-title" id="sidebarTitle">Employee Spotlight</h2>
                </div>

                <div class="sidebar-content" id="sidebarContent">
                    <!-- Page 1 Section (Opening Page - No editable fields) -->
                    <div class="enduser-page-section no-fields">
                        <div class="page-section-header-static">
                            <span class="section-title">Page 1: Opening Page</span>
                            <span class="section-badge">No editable fields</span>
                        </div>
                    </div>

                    <!-- Page 2 Section (Employee Spotlight - has editable fields) -->
                    <div class="enduser-page-section">
                        <button class="page-section-header" onclick="toggleSection(this)">
                            <span class="section-toggle">‚ñº</span>
                            <span class="section-title">Page 2: Employee Spotlight</span>
                            <span class="section-badge">3 fields</span>
                        </button>
                        <div class="page-section-content">
                            <!-- Employee Photo Field -->
                            <div class="enduser-form-field">
                                <label class="field-label">
                                    Employee Photo
                                    <span class="field-required">*</span>
                                </label>
                                <input
                                    type="file"
                                    class="field-file-input"
                                    accept="image/*"
                                    data-field-name="employeePhoto"
                                    style="display: none;"
                                    id="employeePhotoInput">
                                <button class="field-file-btn" onclick="document.getElementById('employeePhotoInput').click()">
                                    üìÅ Choose File
                                </button>
                                <span class="field-hint">Upload employee photo (recommended: 800x800px)</span>
                                <div class="field-image-preview" style="display: none;">
                                    <img src="" alt="Preview">
                                    <button class="field-image-remove" onclick="removeImage()">√ó</button>
                                </div>
                            </div>

                            <!-- Employee Name Field -->
                            <div class="enduser-form-field">
                                <label class="field-label">
                                    Employee Name
                                    <span class="field-required">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="field-input"
                                    placeholder="Enter employee name..."
                                    value="DANI SHTEINBER"
                                    data-field-name="employeeName">
                                <span class="field-hint">Full name of the featured employee</span>
                            </div>

                            <!-- Employee Quote Field -->
                            <div class="enduser-form-field">
                                <label class="field-label">
                                    Employee Quote
                                    <span class="field-required">*</span>
                                </label>
                                <textarea
                                    class="field-textarea"
                                    placeholder="Enter employee quote..."
                                    data-field-name="employeeQuote">I will always choose design over anything else - you can only find that on the wix platforms Thats why i love working with all of the super taleted people eveyday thats what i think and thanks to everyone who taught me to type look how well im typing now and designing and creating and yay</textarea>
                                <span class="field-hint">Employee's testimonial or quote about their experience</span>
                            </div>
                        </div>
                    </div>

                    <!-- Page 3 Section (Closing Page - No editable fields) -->
                    <div class="enduser-page-section no-fields">
                        <div class="page-section-header-static">
                            <span class="section-title">Page 3: Closing Page</span>
                            <span class="section-badge">No editable fields</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Real Canvas Preview -->
            <div class="enduser-canvas-area">
                <div class="canvas-wrapper">
                    <div id="canvasContainer" style="display: flex; justify-content: center; align-items: center;">
                        <!-- Canvas will be injected here by App -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom: Page Navigation -->
        <div class="enduser-page-nav" id="pageNav">
            <div class="page-nav-left">
                <div class="enduser-page-thumbs">
                    <!-- Page 1 Thumbnail -->
                    <div class="enduser-page-thumb" onclick="switchPage(1)">
                        <div class="thumb-preview">
                            <div class="thumb-placeholder">
                                <span class="thumb-number">1</span>
                            </div>
                        </div>
                        <span class="thumb-label">Opening Page</span>
                    </div>

                    <!-- Page 2 Thumbnail (Active by default) -->
                    <div class="enduser-page-thumb active" onclick="switchPage(2)">
                        <div class="thumb-preview">
                            <div class="thumb-placeholder">
                                <span class="thumb-number">2</span>
                            </div>
                        </div>
                        <span class="thumb-label">Employee Spotlight</span>
                        <span class="thumb-indicator">‚óè</span>
                    </div>

                    <!-- Page 3 Thumbnail -->
                    <div class="enduser-page-thumb" onclick="switchPage(3)">
                        <div class="thumb-preview">
                            <div class="thumb-placeholder">
                                <span class="thumb-number">3</span>
                            </div>
                        </div>
                        <span class="thumb-label">Closing Page</span>
                    </div>
                </div>
            </div>

            <div class="page-nav-right">
                <span class="page-indicator">Page 2 of 3</span>
            </div>
        </div>
    </div>

    <!-- JavaScript for Employee Spotlight -->
    <script>
        let app;
        let currentPresetId = null;
        let currentPage = 1;
        let loadedPages = {}; // Store loaded page data

        // Initialize app and show preset selector
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize canvas app
            const container = document.getElementById('canvasContainer');
            app = new App(container, 1080, 1920);
            app.initialize();
            console.log('‚úÖ App initialized');

            // Show preset selector
            document.getElementById('presetSelector').style.display = 'flex';
            // Hide content that should only appear after preset selection
            document.getElementById('sidebarContent').style.display = 'none';
            document.getElementById('pageNav').style.display = 'none';
            document.getElementById('exportBar').style.display = 'none';
        });

        // Load preset from modal dropdown
        function loadPresetFromModal() {
            const dropdown = document.getElementById('modalPresetDropdown');
            const presetId = dropdown.value;

            if (!presetId) {
                alert('Please select a preset first');
                return;
            }

            loadPreset(presetId);
        }

        // Load preset (shows content and closes modal)
        async function loadPreset(presetId) {
            if (!presetId) return;

            console.log('Loading preset:', presetId);
            currentPresetId = presetId;

            try {
                // Update preset name mapping
                const presetNames = {
                    'employee-spotlight': 'Employee Spotlight',
                    'tour-promo': 'Tour Promo',
                    'early-talent': 'Early Talent Program',
                    'city-guides': 'City Guides'
                };

                const selectedPresetName = presetNames[presetId] || 'Unknown Preset';

                // Update sidebar title
                document.getElementById('sidebarTitle').textContent = selectedPresetName;

                // Update header preset name and show it
                const presetLoadedName = document.getElementById('presetLoadedName');
                presetLoadedName.textContent = selectedPresetName;
                presetLoadedName.style.display = 'inline';

                // Show all hidden elements
                document.getElementById('sidebarContent').style.display = 'block';
                document.getElementById('pageNav').style.display = 'flex';
                document.getElementById('exportBar').style.display = 'flex';

                // Close modal
                document.getElementById('presetSelector').style.display = 'none';

                // Load page 2 (employee spotlight page with editable fields)
                await loadPageData(2);

                // Start on Page 2 for employee-spotlight
                switchPage(2);

                console.log('‚úÖ Preset loaded:', selectedPresetName);

            } catch (error) {
                console.error('‚ùå Error loading preset:', error);
                alert('Failed to load preset: ' + error.message);
            }
        }

        // Load page data from preset
        async function loadPageData(pageNumber) {
            try {
                console.log(`Loading page ${pageNumber}...`);

                // Load page from PresetPageManager
                const pageData = await app.presetPageManager.loadPage(currentPresetId, pageNumber);

                // Store loaded page data
                loadedPages[pageNumber] = pageData;

                // Render the page
                app.render();

                console.log(`‚úÖ Page ${pageNumber} loaded with ${pageData.contentSlots?.length || 0} slots`);

                // Build form fields from content slots
                buildFormFromSlots();

            } catch (error) {
                console.error(`‚ùå Error loading page ${pageNumber}:`, error);
                throw error;
            }
        }

        // Build form fields dynamically from content slots
        function buildFormFromSlots() {
            const slots = app.presetPageManager.contentSlotManager.getAllSlots();

            if (slots.length === 0) {
                console.warn('No content slots found for this page');
                return;
            }

            console.log(`Building form from ${slots.length} content slots`);

            // For now, just map to existing fields by fieldName
            // Later we can dynamically generate the form
            slots.forEach(slot => {
                const input = document.querySelector(`[data-field-name="${slot.fieldName}"]`);
                if (input) {
                    // Set up live update
                    input.addEventListener('input', () => {
                        applyFieldUpdate(slot.slotId, input.value || input.files?.[0]);
                    });
                    console.log(`‚úÖ Connected field: ${slot.fieldLabel}`);
                }
            });
        }

        // Apply single field update to canvas
        function applyFieldUpdate(slotId, value) {
            try {
                const slotData = { [slotId]: value };
                app.presetPageManager.applyContentToSlots(slotData);
            } catch (error) {
                console.error('Error applying field update:', error);
            }
        }

        // Toggle page section expand/collapse
        function toggleSection(button) {
            const content = button.nextElementSibling;
            const toggle = button.querySelector('.section-toggle');

            if (button.classList.contains('collapsed')) {
                button.classList.remove('collapsed');
                content.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                button.classList.add('collapsed');
                content.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }

        // Switch page
        async function switchPage(pageNumber) {
            currentPage = pageNumber;

            // Update active thumbnail
            document.querySelectorAll('.enduser-page-thumb').forEach((thumb, index) => {
                if (index + 1 === pageNumber) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });

            // Update page indicator
            const totalPages = document.querySelectorAll('.enduser-page-thumb').length;
            document.querySelector('.page-indicator').textContent = `Page ${pageNumber} of ${totalPages}`;

            // Load page if not already loaded
            if (!loadedPages[pageNumber] && currentPresetId) {
                try {
                    await loadPageData(pageNumber);
                } catch (error) {
                    console.error(`Failed to load page ${pageNumber}:`, error);
                }
            } else if (loadedPages[pageNumber]) {
                // Page already loaded, just apply it
                await app.presetPageManager.applyPageToCanvas(loadedPages[pageNumber]);
                app.render();
            }

            console.log('‚úÖ Switched to page:', pageNumber);
        }

        // Remove uploaded image
        function removeImage() {
            const preview = document.querySelector('.field-image-preview');
            preview.style.display = 'none';
            document.getElementById('employeePhotoInput').value = '';
            console.log('Image removed');
        }

        // Export all pages
        async function exportAllPages() {
            try {
                console.log('Starting export of all pages...');

                const totalPages = document.querySelectorAll('.enduser-page-thumb').length;
                const exportedImages = [];

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    // Load and render page
                    if (!loadedPages[pageNum]) {
                        await loadPageData(pageNum);
                    } else {
                        await app.presetPageManager.applyPageToCanvas(loadedPages[pageNum]);
                        app.render();
                    }

                    // Wait for render to complete
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Export page as PNG
                    const dataUrl = app.canvasManager.canvas.toDataURL('image/png');
                    exportedImages.push({
                        pageNumber: pageNum,
                        dataUrl: dataUrl
                    });

                    console.log(`‚úÖ Exported page ${pageNum}`);
                }

                // Download each image
                exportedImages.forEach(({pageNumber, dataUrl}) => {
                    const link = document.createElement('a');
                    link.download = `${currentPresetId}-page-${pageNumber}.png`;
                    link.href = dataUrl;
                    link.click();
                });

                // Return to current page
                await switchPage(currentPage);

                alert(`‚úÖ Successfully exported ${totalPages} pages!`);
                console.log('‚úÖ Export complete');

            } catch (error) {
                console.error('‚ùå Export failed:', error);
                alert('Export failed: ' + error.message);
            }
        }

        // Image upload preview
        document.getElementById('employeePhotoInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.querySelector('.field-image-preview');
                    const img = preview.querySelector('img');
                    img.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>
